<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小學教師功課管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">📚 功課管理系統</h1>
            <p class="text-gray-600">輕鬆管理每日功課、追蹤進度</p>
        </div>

        <!-- 日期選擇器 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">📅 選擇日期</h2>
                <input type="date" id="selectedDate" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
        </div>

        <!-- 統計卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="showDetailPage('homework')">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">📝 今日功課</h3>
                        <p class="text-3xl font-bold text-blue-600" id="homeworkCount">0</p>
                    </div>
                    <div class="text-4xl">📋</div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="showDetailPage('missing')">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">⚠️ 欠交記錄</h3>
                        <p class="text-3xl font-bold text-red-600" id="missingCount">0</p>
                    </div>
                    <div class="text-4xl">📊</div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 cursor-pointer hover:shadow-xl transition-shadow" onclick="showDetailPage('graded')">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">✅ 已批改</h3>
                        <p class="text-3xl font-bold text-green-600" id="gradedCount">0</p>
                    </div>
                    <div class="text-4xl">✨</div>
                </div>
            </div>
        </div>

        <!-- 主要內容區域 -->
        <div id="mainContent">
            <!-- 功能選項卡 -->
            <div class="bg-white rounded-xl shadow-lg mb-6">
                <div class="flex border-b">
                    <button class="tab-btn flex-1 py-4 px-6 text-center font-medium border-b-2 border-blue-500 text-blue-600" data-tab="homework">📝 發佈功課</button>
                    <button class="tab-btn flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700" data-tab="missing">⚠️ 欠交追蹤</button>
                    <button class="tab-btn flex-1 py-4 px-6 text-center font-medium text-gray-500 hover:text-gray-700" data-tab="graded">✅ 批改記錄</button>
                </div>
            </div>

            <!-- 發佈功課 -->
            <div id="homeworkTab" class="tab-content bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">📝 發佈新功課</h3>
                <form id="homeworkForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                            <select id="homeworkSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="中文">中文</option>
                                <option value="英文">英文</option>
                                <option value="數學">數學</option>
                                <option value="常識">常識</option>
                                <option value="人文">人文</option>
                                <option value="科學">科學</option>
                                <option value="電腦">電腦</option>
                                <option value="班務">班務</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">截止日期</label>
                            <input type="date" id="homeworkDueDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">功課內容</label>
                        <textarea id="homeworkContent" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="請輸入功課詳細內容..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">📝 發佈功課</button>
                </form>
            </div>

            <!-- 欠交追蹤 -->
            <div id="missingTab" class="tab-content bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">⚠️ 記錄欠交學生</h3>
                <form id="missingForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                            <select id="missingSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="中文">中文</option>
                                <option value="英文">英文</option>
                                <option value="數學">數學</option>
                                <option value="常識">常識</option>
                                <option value="人文">人文</option>
                                <option value="科學">科學</option>
                                <option value="電腦">電腦</option>
                                <option value="班務">班務</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">學生姓名</label>
                            <input type="text" id="studentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="請輸入學生姓名">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">欠交功課</label>
                        <input type="text" id="missingHomework" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500" placeholder="請輸入欠交的功課內容">
                    </div>
                    <button type="submit" class="w-full bg-red-600 text-white py-3 px-4 rounded-lg hover:bg-red-700 transition-colors font-medium">⚠️ 記錄欠交</button>
                </form>
            </div>

            <!-- 批改記錄 -->
            <div id="gradedTab" class="tab-content bg-white rounded-xl shadow-lg p-6 hidden">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">✅ 記錄批改完成</h3>
                <form id="gradedForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                            <select id="gradedSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                                <option value="中文">中文</option>
                                <option value="英文">英文</option>
                                <option value="數學">數學</option>
                                <option value="常識">常識</option>
                                <option value="人文">人文</option>
                                <option value="科學">科學</option>
                                <option value="電腦">電腦</option>
                                <option value="班務">班務</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">批改數量</label>
                            <input type="number" id="gradedCount" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="請輸入批改數量">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">功課類型</label>
                        <input type="text" id="gradedHomework" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500" placeholder="請輸入批改的功課類型">
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">✅ 記錄批改</button>
                </form>
            </div>

            <!-- 每日總結 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">📊 每日總結</h3>
                    <button onclick="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors font-medium">📥 匯出Excel</button>
                </div>
                <div id="dailySummary" class="space-y-4">
                    <!-- 動態生成內容 -->
                </div>
            </div>
        </div>

        <!-- 詳細記錄頁面 -->
        <div id="detailPage" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="detailTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="showMainPage()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors">← 返回主頁</button>
                </div>
                <div id="detailContent" class="space-y-4">
                    <!-- 動態生成內容 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 編輯模態框 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">編輯記錄</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <input type="hidden" id="editType">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">科目</label>
                    <select id="editSubject" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="中文">中文</option>
                        <option value="英文">英文</option>
                        <option value="數學">數學</option>
                        <option value="常識">常識</option>
                        <option value="人文">人文</option>
                        <option value="科學">科學</option>
                        <option value="電腦">電腦</option>
                        <option value="班務">班務</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div id="editFields">
                    <!-- 動態生成編輯欄位 -->
                </div>
                <div class="flex space-x-3">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">保存</button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-600 text-white py-2 px-4 rounded-lg hover:bg-gray-700">取消</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 全局變數
        let currentDate = new Date().toISOString().split('T')[0];
        let currentDetailType = '';

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('selectedDate').value = currentDate;
            loadData();
            setupEventListeners();
        });

        // 設置事件監聽器
        function setupEventListeners() {
            // 日期變更
            document.getElementById('selectedDate').addEventListener('change', function() {
                currentDate = this.value;
                loadData();
            });

            // 選項卡切換
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });

            // 表單提交
            document.getElementById('homeworkForm').addEventListener('submit', handleHomeworkSubmit);
            document.getElementById('missingForm').addEventListener('submit', handleMissingSubmit);
            document.getElementById('gradedForm').addEventListener('submit', handleGradedSubmit);
            document.getElementById('editForm').addEventListener('submit', handleEditSubmit);
        }

        // 切換選項卡
        function switchTab(tabName) {
            // 更新按鈕樣式
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('text-gray-500');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('border-blue-500', 'text-blue-600');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-500');

            // 顯示對應內容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
        }

        // 處理功課發佈
        function handleHomeworkSubmit(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                date: currentDate,
                subject: document.getElementById('homeworkSubject').value,
                content: document.getElementById('homeworkContent').value,
                dueDate: document.getElementById('homeworkDueDate').value,
                timestamp: new Date().toLocaleString('zh-TW')
            };

            saveRecord('homework', data);
            document.getElementById('homeworkForm').reset();
            loadData();
            alert('功課發佈成功！');
        }

        // 處理欠交記錄
        function handleMissingSubmit(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                date: currentDate,
                subject: document.getElementById('missingSubject').value,
                studentName: document.getElementById('studentName').value,
                homework: document.getElementById('missingHomework').value,
                timestamp: new Date().toLocaleString('zh-TW')
            };

            saveRecord('missing', data);
            document.getElementById('missingForm').reset();
            loadData();
            alert('欠交記錄已保存！');
        }

        // 處理批改記錄
        function handleGradedSubmit(e) {
            e.preventDefault();
            const data = {
                id: Date.now(),
                date: currentDate,
                subject: document.getElementById('gradedSubject').value,
                homework: document.getElementById('gradedHomework').value,
                count: document.getElementById('gradedCount').value,
                timestamp: new Date().toLocaleString('zh-TW')
            };

            saveRecord('graded', data);
            document.getElementById('gradedForm').reset();
            loadData();
            alert('批改記錄已保存！');
        }

        // 保存記錄
        function saveRecord(type, data) {
            const key = `${type}_${currentDate}`;
            let records = JSON.parse(localStorage.getItem(key) || '[]');
            records.push(data);
            localStorage.setItem(key, JSON.stringify(records));
        }

        // 載入數據
        function loadData() {
            const homework = JSON.parse(localStorage.getItem(`homework_${currentDate}`) || '[]');
            const missing = JSON.parse(localStorage.getItem(`missing_${currentDate}`) || '[]');
            const graded = JSON.parse(localStorage.getItem(`graded_${currentDate}`) || '[]');

            // 更新統計
            document.getElementById('homeworkCount').textContent = homework.length;
            document.getElementById('missingCount').textContent = missing.length;
            document.getElementById('gradedCount').textContent = graded.reduce((sum, item) => sum + parseInt(item.count || 0), 0);

            // 更新每日總結
            updateDailySummary(homework, missing, graded);
        }

        // 更新每日總結
        function updateDailySummary(homework, missing, graded) {
            const summaryDiv = document.getElementById('dailySummary');
            let html = '';

            if (homework.length === 0 && missing.length === 0 && graded.length === 0) {
                html = '<p class="text-gray-500 text-center py-8">今日暫無記錄</p>';
            } else {
                // 功課發佈
                if (homework.length > 0) {
                    html += '<div class="border-l-4 border-blue-500 pl-4"><h4 class="font-semibold text-blue-700 mb-2">📝 今日發佈功課</h4>';
                    homework.forEach(item => {
                        html += `<div class="bg-blue-50 p-3 rounded-lg mb-2 flex justify-between items-start">
                            <div>
                                <span class="font-medium">${item.subject}</span> - ${item.content}
                                ${item.dueDate ? `<br><small class="text-gray-600">截止：${item.dueDate}</small>` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editRecord('homework', ${item.id})" class="text-blue-600 hover:text-blue-800">✏️</button>
                                <button onclick="deleteRecord('homework', ${item.id})" class="text-red-600 hover:text-red-800">🗑️</button>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }

                // 欠交記錄
                if (missing.length > 0) {
                    html += '<div class="border-l-4 border-red-500 pl-4"><h4 class="font-semibold text-red-700 mb-2">⚠️ 欠交記錄</h4>';
                    missing.forEach(item => {
                        html += `<div class="bg-red-50 p-3 rounded-lg mb-2 flex justify-between items-start">
                            <div>
                                <span class="font-medium">${item.subject}</span> - ${item.studentName} 欠交：${item.homework}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editRecord('missing', ${item.id})" class="text-blue-600 hover:text-blue-800">✏️</button>
                                <button onclick="deleteRecord('missing', ${item.id})" class="text-red-600 hover:text-red-800">🗑️</button>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }

                // 批改記錄
                if (graded.length > 0) {
                    html += '<div class="border-l-4 border-green-500 pl-4"><h4 class="font-semibold text-green-700 mb-2">✅ 批改記錄</h4>';
                    graded.forEach(item => {
                        html += `<div class="bg-green-50 p-3 rounded-lg mb-2 flex justify-between items-start">
                            <div>
                                <span class="font-medium">${item.subject}</span> - ${item.homework} (${item.count}份)
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editRecord('graded', ${item.id})" class="text-blue-600 hover:text-blue-800">✏️</button>
                                <button onclick="deleteRecord('graded', ${item.id})" class="text-red-600 hover:text-red-800">🗑️</button>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }
            }

            summaryDiv.innerHTML = html;
        }

        // 顯示詳細頁面
        function showDetailPage(type) {
            currentDetailType = type;
            const titles = {
                homework: '📝 功課發佈記錄',
                missing: '⚠️ 欠交記錄管理',
                graded: '✅ 批改記錄管理'
            };

            document.getElementById('detailTitle').textContent = titles[type];
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('detailPage').classList.remove('hidden');

            loadDetailRecords(type);
        }

        // 載入詳細記錄
        function loadDetailRecords(type) {
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const detailContent = document.getElementById('detailContent');
            
            if (records.length === 0) {
                detailContent.innerHTML = '<p class="text-gray-500 text-center py-8">暫無記錄</p>';
                return;
            }

            let html = '<div class="space-y-4">';
            records.forEach(record => {
                html += `<div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">`;
                
                if (type === 'homework') {
                    html += `<h4 class="font-semibold text-lg">${record.subject}</h4>
                             <p class="text-gray-700 mt-1">${record.content}</p>
                             ${record.dueDate ? `<p class="text-sm text-gray-500 mt-2">截止日期：${record.dueDate}</p>` : ''}`;
                } else if (type === 'missing') {
                    html += `<h4 class="font-semibold text-lg">${record.subject} - ${record.studentName}</h4>
                             <p class="text-gray-700 mt-1">欠交：${record.homework}</p>`;
                } else if (type === 'graded') {
                    html += `<h4 class="font-semibold text-lg">${record.subject}</h4>
                             <p class="text-gray-700 mt-1">${record.homework} (${record.count}份)</p>`;
                }
                
                html += `<p class="text-xs text-gray-400 mt-2">記錄時間：${record.timestamp}</p>
                        </div>
                        <div class="flex space-x-2 ml-4">
                            <button onclick="editRecord('${type}', ${record.id})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm">編輯</button>
                            <button onclick="deleteRecord('${type}', ${record.id})" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm">刪除</button>
                        </div>
                    </div>
                </div>`;
            });
            html += '</div>';
            
            detailContent.innerHTML = html;
        }

        // 顯示主頁面
        function showMainPage() {
            document.getElementById('detailPage').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            loadData();
        }

        // 編輯記錄
        function editRecord(type, id) {
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const record = records.find(r => r.id === id);
            
            if (!record) return;

            document.getElementById('editId').value = id;
            document.getElementById('editType').value = type;
            document.getElementById('editSubject').value = record.subject;

            let fieldsHtml = '';
            if (type === 'homework') {
                fieldsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">功課內容</label>
                        <textarea id="editContent" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">${record.content}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">截止日期</label>
                        <input type="date" id="editDueDate" value="${record.dueDate || ''}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                `;
            } else if (type === 'missing') {
                fieldsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">學生姓名</label>
                        <input type="text" id="editStudentName" value="${record.studentName}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">欠交功課</label>
                        <input type="text" id="editHomework" value="${record.homework}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                `;
            } else if (type === 'graded') {
                fieldsHtml = `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">功課類型</label>
                        <input type="text" id="editHomework" value="${record.homework}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">批改數量</label>
                        <input type="number" id="editCount" value="${record.count}" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    </div>
                `;
            }

            document.getElementById('editFields').innerHTML = fieldsHtml;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        // 處理編輯提交
        function handleEditSubmit(e) {
            e.preventDefault();
            
            const type = document.getElementById('editType').value;
            const id = parseInt(document.getElementById('editId').value);
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const recordIndex = records.findIndex(r => r.id === id);
            
            if (recordIndex === -1) return;

            // 更新記錄
            records[recordIndex].subject = document.getElementById('editSubject').value;
            
            if (type === 'homework') {
                records[recordIndex].content = document.getElementById('editContent').value;
                records[recordIndex].dueDate = document.getElementById('editDueDate').value;
            } else if (type === 'missing') {
                records[recordIndex].studentName = document.getElementById('editStudentName').value;
                records[recordIndex].homework = document.getElementById('editHomework').value;
            } else if (type === 'graded') {
                records[recordIndex].homework = document.getElementById('editHomework').value;
                records[recordIndex].count = document.getElementById('editCount').value;
            }

            localStorage.setItem(`${type}_${currentDate}`, JSON.stringify(records));
            closeEditModal();
            
            if (currentDetailType) {
                loadDetailRecords(currentDetailType);
            } else {
                loadData();
            }
            
            alert('記錄已更新！');
        }

        // 關閉編輯模態框
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // 刪除記錄
        function deleteRecord(type, id) {
            if (!confirm('確定要刪除這筆記錄嗎？')) return;
            
            const records = JSON.parse(localStorage.getItem(`${type}_${currentDate}`) || '[]');
            const filteredRecords = records.filter(r => r.id !== id);
            localStorage.setItem(`${type}_${currentDate}`, JSON.stringify(filteredRecords));
            
            if (currentDetailType) {
                loadDetailRecords(currentDetailType);
            } else {
                loadData();
            }
            
            alert('記錄已刪除！');
        }

        // 匯出Excel
        function exportToExcel() {
            const homework = JSON.parse(localStorage.getItem(`homework_${currentDate}`) || '[]');
            const missing = JSON.parse(localStorage.getItem(`missing_${currentDate}`) || '[]');
            const graded = JSON.parse(localStorage.getItem(`graded_${currentDate}`) || '[]');

            const wb = XLSX.utils.book_new();

            // 功課發佈工作表
            if (homework.length > 0) {
                const homeworkData = homework.map(item => ({
                    '科目': item.subject,
                    '功課內容': item.content,
                    '截止日期': item.dueDate || '',
                    '發佈時間': item.timestamp
                }));
                const ws1 = XLSX.utils.json_to_sheet(homeworkData);
                XLSX.utils.book_append_sheet(wb, ws1, '功課發佈');
            }

            // 欠交記錄工作表
            if (missing.length > 0) {
                const missingData = missing.map(item => ({
                    '科目': item.subject,
                    '學生姓名': item.studentName,
                    '欠交功課': item.homework,
                    '記錄時間': item.timestamp
                }));
                const ws2 = XLSX.utils.json_to_sheet(missingData);
                XLSX.utils.book_append_sheet(wb, ws2, '欠交記錄');
            }

            // 批改記錄工作表
            if (graded.length > 0) {
                const gradedData = graded.map(item => ({
                    '科目': item.subject,
                    '功課類型': item.homework,
                    '批改數量': item.count,
                    '記錄時間': item.timestamp
                }));
                const ws3 = XLSX.utils.json_to_sheet(gradedData);
                XLSX.utils.book_append_sheet(wb, ws3, '批改記錄');
            }

            if (wb.SheetNames.length === 0) {
                alert('今日暫無記錄可匯出！');
                return;
            }

            XLSX.writeFile(wb, `功課管理記錄_${currentDate}.xlsx`);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9822bc8a412185c7',t:'MTc1ODM4NjEzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
